// QT Fashion - Prisma Schema
// Phase 2: Authentication + Designs Catalog

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  CUSTOMER
  DESIGNER
  ADMIN
}

enum OfferStatus {
  PENDING       // Initial offer from customer
  ACCEPTED      // Designer accepted the offer
  REJECTED      // Designer rejected the offer
  COUNTERED     // Designer made a counter offer
  WITHDRAWN     // Customer withdrew the offer
  EXPIRED       // Offer expired
}

enum OrderStatus {
  CONFIRMED     // Order created from accepted offer
  SOURCING      // Fabric sourcing in progress
  CONSTRUCTION  // Garment construction in progress
  QUALITY_CHECK // Quality inspection
  SHIPPING      // Out for delivery
  DELIVERED     // Delivered to customer
  CANCELLED     // Order cancelled
}

// Note: Category is now a String field (not enum) to allow dynamic categories
// without requiring database migrations. Frontend can add new categories anytime.

// ========================================
// MODELS
// ========================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  fullName      String   @default("")
  phoneNumber   String?
  role          UserRole @default(CUSTOMER)
  
  // Optional designer fields
  profileImage  String?
  brandName     String?
  brandLogo     String?
  brandBanner   String?
  bio           String?
  
  // Relations
  designs       Design[]
  offersAsCustomer  Offer[]  @relation("CustomerOffers")
  offersAsDesigner  Offer[]  @relation("DesignerOffers")
  ordersAsCustomer  Order[]  @relation("CustomerOrders")
  ordersAsDesigner  Order[]  @relation("DesignerOrders")
  measurements  BodyMeasurement[]  @relation("UserMeasurements")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("users")
}

model Design {
  id              String          @id @default(cuid())
  designerId      String
  designer        User            @relation(fields: [designerId], references: [id], onDelete: Cascade)
  
  // Design details
  title           String
  description     String
  price           Float
  images          String[]        // Array of image URLs
  category        String          // Dynamic category (e.g., "MODERN", "TRADITIONAL", etc.)
  fabricType      String?
  colors          String[]        // Available colors
  sizes           String[]        // Available sizes
  
  // Customization
  customizable    Boolean         @default(false)
  customizations  Json?           // JSON for custom options
  
  // Production workflow
  productionSteps Json?           // Array of {id, title, estimatedTime, description}
  
  // Metadata
  views           Int             @default(0)
  featured        Boolean         @default(false)
  
  // Relations
  offers          Offer[]
  orders          Order[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("designs")
  @@index([designerId])
  @@index([category])
}

model Offer {
  id              String        @id @default(cuid())
  
  // Relationships
  customerId      String
  customer        User          @relation("CustomerOffers", fields: [customerId], references: [id], onDelete: Cascade)
  
  designerId      String
  designer        User          @relation("DesignerOffers", fields: [designerId], references: [id], onDelete: Cascade)
  
  designId        String
  design          Design        @relation(fields: [designId], references: [id], onDelete: Cascade)
  
  // Offer details
  status          OfferStatus   @default(PENDING)
  customerPrice   Float         // Customer's offered price
  designerPrice   Float?        // Designer's counter price (if countered)
  finalPrice      Float?        // Agreed price (when accepted)
  
  // Customer measurements (optional - for custom orders)
  measurements    Json?
  
  // Additional details
  notes           String?       // Customer's notes/requirements
  designerNotes   String?       // Designer's response notes
  
  // Timestamps
  expiresAt       DateTime?     // Offer expiration
  acceptedAt      DateTime?     // When designer accepted
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  order           Order?        @relation("OfferOrder")

  @@map("offers")
  @@index([customerId])
  @@index([designerId])
  @@index([designId])
  @@index([status])
}

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique // Human-readable order number (e.g., QT-2024-001)
  
  // Original offer reference
  offerId         String        @unique
  offer           Offer         @relation("OfferOrder", fields: [offerId], references: [id], onDelete: Restrict)
  
  // Relationships
  customerId      String
  customer        User          @relation("CustomerOrders", fields: [customerId], references: [id], onDelete: Cascade)
  
  designerId      String
  designer        User          @relation("DesignerOrders", fields: [designerId], references: [id], onDelete: Cascade)
  
  designId        String
  design          Design        @relation(fields: [designId], references: [id], onDelete: Restrict)
  
  // Order details
  status          OrderStatus   @default(CONFIRMED)
  finalPrice      Float         // Agreed price from offer
  
  // Customer measurements (from offer)
  measurements    Json?
  
  // Production tracking
  productionSteps Json?         // Array of {step: string, status: 'pending'|'in_progress'|'completed', completedAt?: date}
  progressNotes   String?       // Designer's progress updates
  
  // Shipment tracking
  carrier         String?
  trackingNumber  String?
  estimatedDelivery DateTime?
  deliveredAt     DateTime?
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("orders")
  @@index([customerId])
  @@index([designerId])
  @@index([designId])
  @@index([status])
  @@index([orderNumber])
}

// Body measurements for virtual try-on
model BodyMeasurement {
  id                  String    @id @default(cuid())
  userId              String
  user                User      @relation("UserMeasurements", fields: [userId], references: [id], onDelete: Cascade)
  
  // Measurements in cm
  chest               Float
  waist               Float
  hips                Float
  height              Float
  shoulder            Float
  armLength           Float
  inseam              Float
  neck                Float
  
  // Photos
  frontPhoto          String
  sidePhoto           String?
  
  // AI metadata
  aiConfidenceScore   Float?
  aiMetadata          Json?
  
  isActive            Boolean   @default(false)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("body_measurements")
  @@index([userId])
  @@index([isActive])
}
